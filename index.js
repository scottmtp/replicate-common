'use strict';

var RtcDataStream = require('rtcstream');

var Promise = require('promise');
var util = require('util');
var EventEmitter = require('events').EventEmitter;
var quickconnect = require('rtc-quickconnect');

var ReplicatorCommon = function(name) {
  this.name = name;

  this.streams = [];
  this.peers = [];

  EventEmitter.call(this);
};

util.inherits(ReplicatorCommon, EventEmitter);
module.exports = ReplicatorCommon;

// api

ReplicatorCommon.prototype.receiveData = function(chunk) {
  console.log('not implemented');
};

ReplicatorCommon.prototype.replicate = function() {
  console.log('not implemented');
};

ReplicatorCommon.prototype.removePeer = function(id) {
  var idx = this.peers.indexOf(id);
  if (idx >= 0) {
    this.peers.splice(idx, 1);
    this.streams.splice(idx, 1);
  }
};

// common methods
ReplicatorCommon.prototype.addPeer = function(id, dc) {
  var self = this;

  var stream = new RtcDataStream(this.name + ':' + id, dc);
  this.peers.push(id);
  this.streams.push(stream);

  stream.on('data', this.receiveData.bind(this));

};

ReplicatorCommon.prototype.getPeers = function() {
  return this.peers;
};
